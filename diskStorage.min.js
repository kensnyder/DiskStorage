/**
 * diskStorage.js: a Wrapper for localStorage
 * Copyright (c) 2010 Ken Snyder under the MIT license: http://www.opensource.org/licenses/mit-license.html
 */
(function(global){function DiskStorage(){this.length=0;this.subscribers=[];this.keys={}}DiskStorage.prototype.setItem=function setItem(key,value){if(this.subscribers.length>0){oldValue=this.getItem(key);this.notify(key,oldValue,value)}value=Object.prototype.toString.call(value)=="[object String]"?value:"\u0002"+JSON.stringify(value);window.localStorage.setItem("\u0001"+key,value);if(!(key in this.keys)){this.length++;this.keys[key]=null}return this};DiskStorage.prototype.getItem=function getItem(key){var value=window.localStorage.getItem("\u0001"+key,value);if(value&&value.charAt(0)=="\u0002"){value=JSON.parse(value.slice(1))}return value};DiskStorage.prototype.removeItem=function removeItem(key){if(this.subscribers.length>0){oldValue=this.getItem(key);this.notify(key,oldValue,undefined)}window.localStorage.removeItem("\u0001"+key);delete this.keys[key];this.length--;return this};DiskStorage.prototype.clear=function clear(){for(var key in this.keys){window.localStorage.removeItem(key)}this.length=0;this.keys={};return this};DiskStorage.prototype.subscribe=function subscribe(callback){this.subscribers.push(callback);return this};DiskStorage.prototype.unsubscribe=function unsubscribe(callback){var newlist=[],i=0,fn;if(arguments.length>0){while((fn=this.subscribers[i++])){if(fn!==callback){newlist.push(fn)}}}this.subscribers=newlist;return this};DiskStorage.prototype.notify=function notify(key,oldValue,newValue){var i=0,fn;while((fn=this.subscribers[i++])){fn({timestamp:+new Date,target:this,key:key,oldValue:oldValue,newValue:newValue,url:window.location.href})}return this};global.diskStorage=new DiskStorage;global.diskStorage.isSupported=function isSupported(){try{return"localStorage" in window&&!!window.localStorage}catch(e){return false}}})(this);
